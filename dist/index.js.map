{"version":3,"file":"index.js","sources":["../src/schema.ts","../src/util.ts","../src/database.ts","../src/persisting-editor.ts","../src/with-persistence.ts"],"sourcesContent":["// Copyright 2020 OpenStax Poland\n// Licensed under the MIT license. See LICENSE file in the project root for\n// full license text.\n\nimport { Node, Operation } from 'slate'\n\n/** State of an opened document */\nexport type State = {\n    /** Document's identification */\n    id: string,\n    /** Document's version when it was last loaded */\n    version: string,\n}\n\n/** A single change to a document */\nexport type Change = {\n    /**\n     * ID of a document to which this change was applied\n     *\n     * This property is indexed.\n     */\n    document: string,\n    /**\n     * Opaque value representing order in which operations are applied\n     *\n     * The exact value of this field is left unspecified, except that it is\n     * guaranteed to be larger than the value for any operation previously\n     * applied to the document.\n     */\n    order: number,\n    /** The operation applied in this change */\n    change: Operation,\n}\n\n/**\n * Content of a document before any {@link Change}s were made\n *\n * We keep it separate from {@link State} to allow querying it without copying\n * potentially huge serialized document.\n */\nexport type Content = {\n    /** Document's identification */\n    id: string,\n    /** Document's contents at the time it was last loaded */\n    content: Node[],\n}\n\n/* eslint-disable func-names */\nconst MIGRATIONS: ((db: IDBDatabase, tx: IDBTransaction) => void)[] = [\n    // A dummy migration to fill index 0. It will never be executed, since\n    // database versions start at 1 (0 is the “version” before first migration,\n    // when database is created).\n    /* eslint-disable-next-line @typescript-eslint/no-empty-function */\n    function() {},\n    // 0 → 1\n    function(db) {\n        db.createObjectStore('states', { keyPath: 'id' })\n        db.createObjectStore('contents', { keyPath: 'id' })\n\n        const changes = db.createObjectStore('changes', {\n            keyPath: 'order',\n            autoIncrement: true,\n        })\n        changes.createIndex('document', 'document', {\n            unique: false,\n            multiEntry: true,\n        })\n    },\n]\n/* eslint-enable func-names */\n\nexport function upgradeDatabase(event: IDBVersionChangeEvent): void {\n    const { newVersion, oldVersion } = event\n    const { result: db, transaction: tx } = event.target as IDBOpenDBRequest\n\n    if (newVersion === null || tx === null) {\n        // We're being deleted.\n        return\n    }\n\n    for (let ver = oldVersion + 1; ver <= newVersion; ++ver) {\n        MIGRATIONS[ver](db, tx)\n    }\n}\n","// Copyright 2020 OpenStax Poland\n// Licensed under the MIT license. See LICENSE file in the project root for\n// full license text.\n\n/** Convert an IndexedDB request into a promise */\nexport async function promisify<T>(req: IDBRequest<T>): Promise<T> {\n    return new Promise((resolve, reject) => {\n        /* eslint-disable-next-line\n            @typescript-eslint/prefer-promise-reject-errors */\n        req.onerror = () => reject(req.error)\n        req.onsuccess = () => resolve(req.result)\n    })\n}\n\nexport type IterateCallback<T> = (\n    cursor: IDBCursor,\n    value: T,\n    reject: <T extends Error> (err: T) => void,\n) => void\n\nexport async function iterate<T>(\n    store: IDBObjectStore | IDBIndex,\n    f: IterateCallback<T>,\n): Promise<void>\n\nexport async function iterate<T>(\n    store: IDBObjectStore | IDBIndex,\n    query: IDBValidKey | IDBKeyRange | null,\n    f: IterateCallback<T>,\n): Promise<void>\n\nexport async function iterate<T>(\n    store: IDBObjectStore | IDBIndex,\n    query: IDBValidKey | IDBKeyRange | null,\n    direction: IDBCursorDirection,\n    f: IterateCallback<T>,\n): Promise<void>\n\n/**\n * Call closure once for each item in a cursor\n *\n * The closure is responsible for advancing cursor to the next value.\n *\n * Returned promise will be resolved once iteration has successfully completed\n * (there are no more items remaining in the cursor), or rejected on a database\n * error, or if closure throws.\n */\nexport async function iterate<T>(\n    store: IDBObjectStore | IDBIndex,\n    ...args: any[] // eslint-disable-line @typescript-eslint/no-explicit-any\n): Promise<void> {\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n    const f: IterateCallback<T> = args.pop()\n\n    return new Promise((resolve, reject) => {\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n        const req = store.openCursor(...args)\n        /* eslint-disable-next-line\n            @typescript-eslint/prefer-promise-reject-errors */\n        req.onerror = err => reject(err)\n        req.onsuccess = event => {\n            const cursor = (event.target as IDBRequest).result as IDBCursorWithValue\n            if (cursor) {\n                try {\n                    f(cursor, cursor.value as T, reject)\n                } catch (ex) {\n                    /* eslint-disable-next-line\n                        @typescript-eslint/prefer-promise-reject-errors */\n                    reject(ex)\n                }\n            } else {\n                resolve()\n            }\n        }\n    })\n}\n\nexport interface Export {\n    database: {\n        name: string,\n        version: number,\n        objectStores: ObjectStoreMap,\n    }\n    remove: RemoveMap\n    insert: InsertMap\n}\n\nexport interface ObjectStore {\n    keyPath: string | string[]\n    autoIncrement: boolean\n    indexes: IndexMap\n}\n\nexport type ObjectStoreMap = { [name: string]: ObjectStore }\n\nexport interface Index {\n    name: string\n    keyPath: string | string[]\n    multiEntry: boolean\n    unique: boolean\n}\n\nexport type IndexMap = { [name: string]: Index }\n\nexport interface RemoveSpec {\n    key?: string | string[]\n    index?: string\n}\n\nexport type RemoveMap = { [storeName: string]: RemoveSpec }\n\nexport type InsertMap = { [storeName: string]: unknown[] }\n\n/**\n * Export contents of a database as a JS object\n *\n * Returned object can later be used to import data into a database using\n * {@link #importDatabase}. It contains only plain JS values and can safely be\n * converted to/from JSON.\n */\nexport async function exportDatabase(db: IDBDatabase): Promise<Export> {\n    // db.objectStoresNames has type DOMStringList, which contrary to TS's\n    // typpings is allowed as an argument to IDBDatabase#transaction.\n    const tx = db.transaction(db.objectStoreNames as unknown as string[], 'readonly')\n    const insert: InsertMap = {}\n    const objectStores: ObjectStoreMap = {}\n\n    for (const name of db.objectStoreNames) {\n        const store = tx.objectStore(name)\n        const indexes = Object.fromEntries(Array.from(store.indexNames, name => {\n            const index = store.index(name)\n            return [name, {\n                name: index.name,\n                keyPath: index.keyPath,\n                multiEntry: index.multiEntry,\n                unique: index.unique,\n            }]\n        }))\n\n        insert[name] = await promisify(store.getAll())\n\n        objectStores[name] = {\n            indexes,\n            keyPath: store.keyPath!,\n            autoIncrement: store.autoIncrement,\n        }\n    }\n\n    return {\n        database: {\n            name: db.name,\n            version: db.version,\n            objectStores,\n        },\n        remove: Object.fromEntries(\n            Array.from(db.objectStoreNames, st => [st, {}])),\n        insert,\n    }\n}\n\n/** Import data into a database */\nexport async function importDatabase(db: IDBDatabase, data: Export): Promise<void> {\n    const { database: { name, version }, remove = {}, insert = {} } = data\n\n    if (name !== db.name) {\n        throw new Error(\n            `Cannot import data for database ${name} into potentially \\\n            incompatible database ${db.name}`)\n    }\n    if (version !== db.version) {\n        throw new Error(\n            `Imported data is in an incompatible format ${version} \\\n            (this database uses ${db.version}`)\n    }\n\n    const tx = db.transaction(db.objectStoreNames as unknown as string[], 'readwrite')\n\n    for (const [name, { key, index }] of Object.entries(remove)) {\n        const store = tx.objectStore(name)\n        const keys = key && (key instanceof Array ? key : [key])\n\n        if (index && keys) {\n            const inx = store.index(index)\n\n            for (const key of keys) {\n                await iterate(inx, key, cursor => {\n                    cursor.delete()\n                    cursor.continue()\n                })\n            }\n        } else if (keys) {\n            for (const key of keys) {\n                await promisify(store.delete(key))\n            }\n        } else {\n            await promisify(store.clear())\n        }\n    }\n\n    for (const [name, values] of Object.entries(insert)) {\n        const store = tx.objectStore(name)\n\n        for (const val of values) {\n            await promisify(store.add(val))\n        }\n    }\n}\n","// Copyright 2020 OpenStax Poland\n// Licensed under the MIT license. See LICENSE file in the project root for\n// full license text.\n\nimport { Node, Operation } from 'slate'\n\nimport { Change, Content, State, upgradeDatabase } from './schema'\nimport { Export, exportDatabase, importDatabase, iterate, promisify } from './util'\n\nexport { State }\n\nconst DB_NAME = 'manuscript:persist'\nconst DB_VERSION = 1\n\nlet DATABASE: PersistDB | null = null\n\n/** Management of and access to the persistence database */\nexport class PersistDB {\n    /** Open the database */\n    public static async open(): Promise<PersistDB> {\n        if (DATABASE !== null) return DATABASE\n\n        const req = window.indexedDB.open(DB_NAME, DB_VERSION)\n        req.onupgradeneeded = upgradeDatabase\n\n        const db = await promisify(req)\n\n        DATABASE = new PersistDB(db)\n\n        return DATABASE\n    }\n\n    /**\n     * Load a document\n     *\n     * This is a convenience wrapper around {@link #open}\n     * and {@link #openDocument}.\n     */\n    public static async load(id: string): Promise<DocumentDB> {\n        return PersistDB.open().then(async db => db.openDocument(id))\n    }\n\n    private readonly database: IDBDatabase\n\n    private constructor(db: IDBDatabase) {\n        this.database = db\n    }\n\n    /**\n     * Export contents of this database as a JS object\n     *\n     * Returned object can later be used to import data into a database using\n     * {@link #import}. It contains only plain JS values and can safely be\n     * converted to/from JSON.\n     */\n    public async export(): Promise<Export> {\n        return exportDatabase(this.database)\n    }\n\n    /** Import data into a database */\n    public async import(data: Export): Promise<void> {\n        return importDatabase(this.database, data)\n    }\n\n    /** Open a document */\n    public async openDocument(id: string): Promise<DocumentDB> {\n        const tx = this.database.transaction(['states', 'changes'])\n        const store = tx.objectStore('states')\n        const document = new DocumentDB(this.database, id)\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n        const data = await promisify<State>(store.get(id))\n\n        if (!data) {\n            return document\n        }\n\n        const index = tx.objectStore('changes').index('document')\n        const count = await promisify(index.count(id))\n        document.dirty = count > 0\n        document.version = data.version\n\n        return document\n    }\n\n    /** Get a list of all modules with local unsaved changes */\n    public async dirty(): Promise<State[]> {\n        const tx = this.database.transaction(\n            ['states', 'changes', 'contents'], 'readwrite')\n        const states = tx.objectStore('states')\n        const changes = tx.objectStore('changes').index('document')\n        const contents = tx.objectStore('contents')\n\n        const dirty: State[] = []\n\n        await iterate<State>(states, async (cursor, value) => {\n            const count = await promisify(changes.count(value.id))\n\n            if (count === 0) {\n                cursor.delete()\n                contents.delete(value.id)\n            } else {\n                dirty.push(value)\n            }\n\n            cursor.continue()\n        })\n\n        return dirty\n    }\n\n    /**\n     * Discard any saved changes to a document\n     *\n     * This has the same effect as calling {@link DocumentDB#discard} on\n     * a loaded document.\n     */\n    public async discard(id: string): Promise<void> {\n        return new DocumentDB(this.database, id).discard()\n    }\n}\n\n/** Local state of a document */\nexport class DocumentDB {\n    private readonly database: IDBDatabase\n\n    public readonly id: string\n\n    public dirty: boolean\n\n    public version: string | null\n\n    /** @internal */\n    public constructor(db: IDBDatabase, id: string) {\n        this.database = db\n        this.id = id\n        this.dirty = false\n        this.version = null\n    }\n\n    /** Save a new version of a document */\n    public async save(value: Node[], version: string): Promise<void> {\n        const tx = this.database.transaction(\n            ['states', 'changes', 'contents'], 'readwrite')\n        const states = tx.objectStore('states')\n        const changes = tx.objectStore('changes').index('document')\n        const contents = tx.objectStore('contents')\n\n        await iterate(changes, this.id, cursor => {\n            cursor.delete()\n            cursor.continue()\n        })\n\n        await Promise.all([\n            states.put({\n                id: this.id,\n                version,\n            }),\n            contents.put({\n                id: this.id,\n                content: value,\n            }),\n        ].map(promisify))\n\n        this.version = version\n        this.dirty = false\n    }\n\n    /** Mark a change to the document */\n    public async mark(op: Operation): Promise<void> {\n        const tx = this.database.transaction('changes', 'readwrite')\n        const store = tx.objectStore('changes')\n\n        await promisify(store.add({\n            document: this.id,\n            change: op,\n        }))\n\n        this.dirty = true\n    }\n\n    /**\n     * Restore document from its saved state\n     */\n    public async restore(): Promise<[Node[], Operation[]]> {\n        const tx = this.database.transaction(['contents', 'changes'])\n        const contents = tx.objectStore('contents')\n        const changes = tx.objectStore('changes').index('document')\n\n        /* eslint-disable @typescript-eslint/no-unsafe-argument */\n        const [value, ops] = await Promise.all([\n            promisify<Content>(contents.get(this.id)),\n            promisify<Change[]>(changes.getAll(this.id)),\n        ])\n        /* eslint-enable @typescript-eslint/no-unsafe-argument */\n\n        return [value.content, ops.map(o => o.change)]\n    }\n\n    /** Discard any saved changes to a document */\n    public async discard(): Promise<void> {\n        const tx = this.database.transaction(\n            ['states', 'changes', 'contents'], 'readwrite')\n        const states = tx.objectStore('states')\n        const changes = tx.objectStore('changes').index('document')\n        const contents = tx.objectStore('contents')\n\n        await Promise.all([\n            iterate(changes, this.id, cursor => {\n                cursor.delete()\n                cursor.continue()\n            }),\n            promisify(states.delete(this.id)),\n            promisify(contents.delete(this.id)),\n        ])\n\n        this.dirty = false\n    }\n}\n","// Copyright 2020 OpenStax Poland\n// Licensed under the MIT license. See LICENSE file in the project root for\n// full license text.\n\nimport { Editor } from 'slate'\n\nimport { DocumentDB } from './database'\n\nexport interface PersistingEditor extends Editor {\n    documentDB: DocumentDB\n\n    /**\n     * Function called when all changes have been persisted to IndexedDB\n     *\n     * This function will be called once for each call to\n     * {@link Editor#onChange}. There may be a delay between a call to\n     * {@link Editor#onChange} and a corresponding call to this function, and\n     * that delay may be long enough for another change to occur.\n     */\n    onChangesPersisted: () => void\n    restore: () => Promise<void>\n}\n\nexport const PersistingEditor = {\n    /**\n     * Check if a value is a `PersistingEditor` object.\n     */\n    isPersistingEditor(value: unknown): value is PersistingEditor {\n        return Editor.isEditor(value)\n            && typeof (value as PersistingEditor).restore === 'function'\n            && (value as PersistingEditor).documentDB instanceof DocumentDB\n    },\n\n    /**\n     * Check if changes have been made to the editor since the last time it was\n     * saved.\n     */\n    hasChanges(editor: PersistingEditor): boolean {\n        return editor.documentDB.dirty\n    },\n\n    /**\n     * Restore editor to last state saved in {@link DocumentDB}\n     *\n     * If this editor also uses `withHistory` the history will be cleared.\n     */\n    async restore(editor: PersistingEditor): Promise<void> {\n        return editor.restore()\n    },\n}\n","// Copyright 2020 OpenStax Poland\n// Licensed under the MIT license. See LICENSE file in the project root for\n// full license text.\n\nimport { Editor, Operation } from 'slate'\n\nimport { DocumentDB } from './database'\nimport { PersistingEditor } from './persisting-editor'\n\nconst SYNC = new WeakMap<Editor, Promise<void>>()\n\nfunction synchronised<T extends unknown[]>(key: Editor, f: (...args: T) => Promise<void>) {\n    return async (...args: T) => {\n        const sync = SYNC.get(key) ?? Promise.resolve()\n        const r = (async () => {\n            await sync\n            await f(...args)\n        })()\n        SYNC.set(key, r)\n        return r\n    }\n}\n\nexport default function withPersistence<T extends Editor>(\n    db: DocumentDB,\n    editor: T,\n): T & PersistingEditor {\n    const e = editor as T & PersistingEditor\n    const { apply, onChange } = e\n\n    e.documentDB = db\n    e.onChangesPersisted = () => {} // eslint-disable-line @typescript-eslint/no-empty-function\n\n    const persist = synchronised(e, async (operations: Operation[]) => {\n        for (const op of operations) {\n            if (!IGNORED_OPERATIONS.includes(op.type)) {\n                await e.documentDB.mark(op)\n            }\n        }\n\n        e.onChangesPersisted()\n    })\n\n    e.onChange = () => {\n        void persist(e.operations)\n        onChange()\n    }\n\n    e.restore = synchronised(e, async () => {\n        const [state, ops] = await e.documentDB.restore()\n\n        Editor.withoutNormalizing(e, () => {\n            e.children = state\n\n            for (const op of ops) {\n                apply(op)\n            }\n        })\n\n        if ('history' in e) {\n            (e as Record<string, unknown>).history = { undos: [], redos: [] }\n        }\n\n        e.operations = []\n\n        e.onChange()\n        e.onChangesPersisted()\n    })\n\n    return e\n}\n\n/**\n * Operations which not result in meaningful changes to the document.\n *\n * Operations which don't modify document content, such as moving cursor around,\n * can safely be ignored when restoring state.\n */\nconst IGNORED_OPERATIONS = [\n    'set_selection',\n]\n"],"names":[],"mappings":"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"}